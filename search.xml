<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>15-445 BUFFER POOL</title>
    <url>/2021/12/14/CMU-15-445-PROJECT-1-BUFFER-POOL/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>database course</category>
      </categories>
      <tags>
        <tag>cmu 15-445</tag>
      </tags>
  </entry>
  <entry>
    <title>GFS è®ºæ–‡ç ”è¯»</title>
    <url>/2021/11/13/GFS-%E8%AE%BA%E6%96%87%E7%A0%94%E8%AF%BB/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>paper</category>
      </categories>
  </entry>
  <entry>
    <title>OceanBase æ•°æ®åº“å¤§èµ›</title>
    <url>/2021/11/25/OceanBase-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%A7%E8%B5%9B/</url>
    <content><![CDATA[<h1 id="èµ›é¢˜æè¿°"><a href="#èµ›é¢˜æè¿°" class="headerlink" title="èµ›é¢˜æè¿°"></a>èµ›é¢˜æè¿°</h1><p>åœ¨å¼€æºç‰ˆæœ¬ OceanBase çš„åŸºç¡€ä¸Š, é’ˆå¯¹ Nested Loop Join åœºæ™¯åšæ€§èƒ½ä¼˜åŒ–. é‡‡ç”¨ sysbench åŸºå‡†æµ‹è¯•ä¸­ Throughput çš„ events/s (eps) è¿™ä¸€é¡¹ä½œä¸ºæ’åä¾æ®.</p>
<h1 id="èµ›é¢˜è§£æ"><a href="#èµ›é¢˜è§£æ" class="headerlink" title="èµ›é¢˜è§£æ"></a>èµ›é¢˜è§£æ</h1><h2 id="ä»€ä¹ˆæ˜¯-Nested-Loop-Join"><a href="#ä»€ä¹ˆæ˜¯-Nested-Loop-Join" class="headerlink" title="ä»€ä¹ˆæ˜¯ Nested Loop Join?"></a>ä»€ä¹ˆæ˜¯ Nested Loop Join?</h2><p>Nested Loop Join æ˜¯ä¸€ç§å¸¸è§çš„æ•°æ®åº“æŸ¥è¯¢æ“ä½œ, å…¶ä¸­ä¸¤ä¸ªè¡¨çš„æ•°æ®é‡ç›¸å¯¹è¾ƒå°, ä¸”ä¸¤ä¸ªè¡¨çš„å…³è”å…³ç³»ç›¸å¯¹è¾ƒç®€å•.<br>Nested Loop Join çš„åŸºæœ¬åŸç†æ˜¯æ¯æ¬¡ä»å·¦è¡¨è·å–ä¸€è¡Œ, ç„¶åç”¨è¿™è¡Œæ•°æ®å’Œå³è¡¨è¿›è¡Œ Join. ä¸å³è¡¨è¿›è¡Œ Join æ—¶, å¯ä»¥é€šè¿‡ç´¢å¼•æŸ¥è¯¢é™ä½å¤æ‚åº¦.</p>
<h2 id="è¡¨ç»“æ„"><a href="#è¡¨ç»“æ„" class="headerlink" title="è¡¨ç»“æ„"></a>è¡¨ç»“æ„</h2><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> query</span><br><span class="line"></span><br><span class="line">query = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">[[</span></span><br><span class="line"><span class="string">   CREATE TABLE t%d(</span></span><br><span class="line"><span class="string">     c1 int primary key, c2 int, c3 int, v1 CHAR(60), v2 CHAR(60), v3 CHAR(60), v4 CHAR(60), v5 CHAR(60), v6 CHAR(60), v7 CHAR(60), v8 CHAR(60), v9 CHAR(60)</span></span><br><span class="line"><span class="string">     )]]</span>, table_id)</span><br><span class="line"></span><br><span class="line">do_query(drv, con, <span class="string">&quot;create index t2_i1 on t2(c2) local&quot;</span>)</span><br><span class="line">do_query(drv, con, <span class="string">&quot;create index t2_i2 on t2(c3) local&quot;</span>)</span><br><span class="line"></span><br><span class="line">ival = sysbench.rand.default(<span class="number">1</span>, sysbench.opt.table_size)</span><br><span class="line">left_min = ival - <span class="number">100</span>;</span><br><span class="line">left_max = ival + <span class="number">100</span>;</span><br><span class="line">cond = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;A.c1 &gt;= %d and A.c1 &lt; %d and A.c2 = B.c2 and A.c3 = B.c3&quot;</span>, left_min, left_max)</span><br><span class="line">query = <span class="string">&quot;select /*+ordered use_nl(A,B)*/ * from t1 A, t2 B where &quot;</span> .. cond</span><br></pre></td></tr></table></figure>

<h2 id="æŸ¥è¯¢è¯­å¥"><a href="#æŸ¥è¯¢è¯­å¥" class="headerlink" title="æŸ¥è¯¢è¯­å¥"></a>æŸ¥è¯¢è¯­å¥</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> åŸå§‹æŸ¥è¯¢è¯­å¥</span><br><span class="line">  <span class="keyword">select</span> <span class="comment">/*+ordered use_nl(A,B)*/</span> <span class="operator">*</span> <span class="keyword">from</span> t1 A, t2 B </span><br><span class="line">  <span class="keyword">where</span> A.c1 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> A.c1 <span class="operator">&lt;</span> <span class="number">200</span> </span><br><span class="line">  <span class="keyword">and</span> A.c2 <span class="operator">=</span> B.c2 <span class="keyword">and</span> A.c3 <span class="operator">=</span> B.c3;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> <span class="comment">/*+ordered use_nl(A,B)*/</span> <span class="operator">*</span> <span class="keyword">from</span> t1 A, t2 B <span class="keyword">where</span> A.c1 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> A.c1 <span class="operator">&lt;</span> <span class="number">200</span> <span class="keyword">and</span> A.c2 <span class="operator">=</span> B.c2 <span class="keyword">and</span> A.c3 <span class="operator">=</span> B.c3;</span><br><span class="line">  explain <span class="keyword">select</span> <span class="comment">/*+ordered use_nl(A,B)*/</span> <span class="operator">*</span> <span class="keyword">from</span> t1 A, t2 B <span class="keyword">where</span> A.c1 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> A.c1 <span class="operator">&lt;</span> <span class="number">200</span> <span class="keyword">and</span> A.c2 <span class="operator">=</span> B.c2 <span class="keyword">and</span> A.c3 <span class="operator">=</span> B.c3;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> å½“ A.c1 <span class="operator">=</span> A.c2 æ—¶, æ”¹å†™åçš„æŸ¥è¯¢è¯­å¥</span><br><span class="line">  <span class="keyword">select</span> <span class="comment">/*+ordered use_nl(A,B)*/</span> <span class="operator">*</span> <span class="keyword">from</span> t1 A, t2 B </span><br><span class="line">  <span class="keyword">where</span> A.c1 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> A.c1 <span class="operator">&lt;</span> <span class="number">200</span> </span><br><span class="line">  <span class="keyword">and</span> B.c2 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> B.c2 <span class="operator">&lt;</span> <span class="number">200</span> </span><br><span class="line">  <span class="keyword">and</span> A.c3 <span class="operator">=</span> B.c3;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> <span class="comment">/*+ordered use_nl(A,B)*/</span> <span class="operator">*</span> <span class="keyword">from</span> t1 A, t2 B <span class="keyword">where</span> A.c1 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> A.c1 <span class="operator">&lt;</span> <span class="number">200</span> <span class="keyword">and</span> B.c2 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> B.c2 <span class="operator">&lt;</span> <span class="number">200</span> <span class="keyword">and</span> A.c3 <span class="operator">=</span> B.c3;</span><br><span class="line">  explain <span class="keyword">select</span> <span class="comment">/*+ordered use_nl(A,B)*/</span> <span class="operator">*</span> <span class="keyword">from</span> t1 A, t2 B <span class="keyword">where</span> A.c1 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> A.c1 <span class="operator">&lt;</span> <span class="number">200</span> <span class="keyword">and</span> B.c2 <span class="operator">&gt;=</span> <span class="number">100</span> <span class="keyword">and</span> B.c2 <span class="operator">&lt;</span> <span class="number">200</span> <span class="keyword">and</span> A.c3 <span class="operator">=</span> B.c3;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
  </entry>
  <entry>
    <title>Raft-è®ºæ–‡ç ”è¯»</title>
    <url>/2022/01/17/Raft-%E8%AE%BA%E6%96%87%E7%A0%94%E8%AF%BB/</url>
    <content><![CDATA[<span id="more"></span>]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>Raft</tag>
      </tags>
  </entry>
  <entry>
    <title>TiDB-PD</title>
    <url>/2022/03/22/TiKV-PD/</url>
    <content><![CDATA[<p>PD æ˜¯ TiDB é‡Œçš„å…¨å±€ä¸­å¿ƒæ€»æ§èŠ‚ç‚¹, ä¸»è¦è´Ÿè´£å…¨å±€å…ƒä¿¡æ¯çš„å­˜å‚¨ä»¥åŠ TiKV é›†ç¾¤è´Ÿè½½å‡è¡¡è°ƒåº¦.</p>
<span id="more"></span>

<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>PD æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„å•ç‚¹, ç‰©ç†ä¸Šæ˜¯ä¸€ä¸ªé›†ç¾¤, é›†æˆ etcd, æ”¯æŒæ•…éšœæ¢å¤, ä¿è¯äº†å¼ºä¸€è‡´æ€§.<br>PD åŠŸèƒ½å¯ä»¥åˆ†ä¸ºä¸‰ç±»:</p>
<ol>
<li>è·¯ç”±</li>
<li>å…ƒæ•°æ®ç®¡ç†</li>
<li>è°ƒåº¦</li>
</ol>
<p>TiKV ä¸­çš„ Region Leader ä¸ Store ä¼šå®šæœŸå‘ PD å‘é€ Heartbeat, Heartbeat ä¸­åŒ…å«äº† Region å’Œ Store çš„å„ç§çŠ¶æ€ä¿¡æ¯,<br>PD æ ¹æ®çŠ¶æ€ä¿¡æ¯æ¥è°ƒåº¦ TiKV é›†ç¾¤çš„è´Ÿè½½å‡è¡¡, å°† Operator é€šè¿‡ Heartbeat response å›å¤ç»™ TiKV.</p>
<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="1-Scheduler"><a href="#1-Scheduler" class="headerlink" title="1. Scheduler"></a>1. Scheduler</h3><p>Scheduler æ˜¯ç”¨æ¥è°ƒåº¦èµ„æºçš„æ¥å£, è°ƒåº¦å™¨é€šè¿‡çŠ¶æ€ä¿¡æ¯ç”Ÿæˆ Operator.</p>
<h3 id="2-Operator"><a href="#2-Operator" class="headerlink" title="2. Operator"></a>2. Operator</h3><p>Operator æ˜¯ PD å¯¹ TiKV çš„è°ƒåº¦æ“ä½œçš„é›†åˆ, å¯ä»¥ç”±å…¶ä»– Operator ç»„åˆè€Œæˆ.</p>
<h3 id="3-Selector-Filter"><a href="#3-Selector-Filter" class="headerlink" title="3. Selector/Filter"></a>3. Selector/Filter</h3><p>Selector ä¸ Filter è´Ÿè´£é€‰æ‹©è°ƒåº¦æ“ä½œçš„ source ä¸ target.</p>
<h3 id="4-Controller"><a href="#4-Controller" class="headerlink" title="4. Controller"></a>4. Controller</h3><p>Controller è´Ÿè´£æ§åˆ¶æ•´ä¸ªè°ƒåº¦çš„é€Ÿåº¦.</p>
<h3 id="5-Coordinator"><a href="#5-Coordinator" class="headerlink" title="5. Coordinator"></a>5. Coordinator</h3><p>Coordinator åœ¨ Region Heartbeat ä¼šæ£€æµ‹ Region æ˜¯å¦éœ€è¦è°ƒåº¦, å¦‚æœéœ€è¦, åˆ™è¿›è¡Œè°ƒåº¦.</p>
<p>PD ä¸­æœ‰è®¸å¤šè°ƒåº¦å™¨, æ¯ä¸ªè°ƒåº¦å™¨æ˜¯ç‹¬ç«‹è¿è¡Œçš„, æœ‰ç€ä¸åŒçš„è°ƒåº¦ç›®çš„.<br>å¸¸è§çš„è°ƒåº¦å™¨æœ‰:</p>
<ul>
<li>balance-leader-scheduler: ä¿æŒä¸åŒèŠ‚ç‚¹çš„ Leader å‡è¡¡.</li>
<li>balance-region-scheduler: ä¿æŒä¸åŒèŠ‚ç‚¹çš„ Region å‡è¡¡.</li>
<li>hot-region-scheduler: ä¿æŒä¸åŒèŠ‚ç‚¹çš„è¯»å†™çƒ­ç‚¹ Region å‡è¡¡.</li>
<li>evict-leader-{store-id}: é©±é€æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ Leader.</li>
</ul>
<h2 id="è°ƒåº¦æµç¨‹"><a href="#è°ƒåº¦æµç¨‹" class="headerlink" title="è°ƒåº¦æµç¨‹"></a>è°ƒåº¦æµç¨‹</h2><p>è°ƒåº¦çš„æµç¨‹å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†:</p>
<ol>
<li><p>ä¿¡æ¯æ”¶é›†<br>Region Leader å‘¨æœŸæ€§åœ°ä¸ŠæŠ¥ RegionHeartbeat å¿ƒè·³, åŒ…å«äº† Region èŒƒå›´, å‰¯æœ¬åˆ†å¸ƒ, å‰¯æœ¬çŠ¶æ€, æ•°æ®é‡, è¯»å†™æµé‡ç­‰æ•°æ®.<br>Store å‘¨æœŸæ€§åœ°ä¸ŠæŠ¥ StoreHeartbeat å¿ƒè·³, åŒ…å«äº† Store çš„åŸºæœ¬ä¿¡æ¯, å®¹é‡, å‰©ä½™ç©ºé—´, è¯»å†™æµé‡ç­‰æ•°æ®.</p>
</li>
<li><p>ç”Ÿæˆè°ƒåº¦</p>
</li>
<li><p>æ‰§è¡Œè°ƒåº¦<br>å°† Operator Step ä¸‹å‘ç»™å¯¹åº” Region çš„ Leader.</p>
</li>
</ol>
<p>é›†ç¾¤çš„å…ƒä¿¡æ¯ã€TSO ä¿¡æ¯ã€Region ä¿¡æ¯ æŒä¹…åŒ–åœ¨ etcd ä¸­.<br>Store ä¸ Region çš„çŠ¶æ€å­˜åœ¨ cache ä¸­.</p>
]]></content>
      <categories>
        <category>databases</category>
      </categories>
      <tags>
        <tag>TiDB</tag>
      </tags>
  </entry>
  <entry>
    <title>oceanbase-competition-final</title>
    <url>/2021/12/25/oceanbase-competition-final/</url>
    <content><![CDATA[<p>doing</p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
  </entry>
  <entry>
    <title>TinyKV Project1 StandaloneKV</title>
    <url>/2022/01/16/tinykv-project1-StandaloneKV/</url>
    <content><![CDATA[<p>TinyKV Project1, åŸºäº badger æ„é€ ä¸€ä¸ªå•æœºçš„æ”¯æŒåˆ—æ—å­˜å‚¨çš„ gRPC æœåŠ¡.</p>
<span id="more"></span>

<h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><p>åŸºäº badger æ„é€ ä¸€ä¸ªå•æœºçš„æ”¯æŒåˆ—æ—å­˜å‚¨çš„ gRPC æœåŠ¡.<br>è¿™ä¸€æœåŠ¡æä¾›å››ç§åŸºæœ¬æ“ä½œ: <code>Put</code>/<code>Delete</code>/<code>Get</code>/<code>Scan</code>.</p>
<ul>
<li>Put: å‘æŒ‡å®šåˆ—æ—ä¸­å†™å…¥.</li>
<li>Get: ä»æŒ‡å®šåˆ—æ—ä¸­è¯»å–.</li>
<li>Delete: åˆ é™¤æŒ‡å®šåˆ—æ—çš„æŒ‡å®šå€¼.</li>
<li>Scan: ä»æŒ‡å®šåˆ—æ—ä¸­é¡ºåºè¯»å–å¤šä¸ªå€¼.</li>
</ul>
<h2 id="Implement-standalone-storage-engine"><a href="#Implement-standalone-storage-engine" class="headerlink" title="Implement standalone storage engine"></a>Implement standalone storage engine</h2><h3 id="é¢˜ç›®è§£æ"><a href="#é¢˜ç›®è§£æ" class="headerlink" title="é¢˜ç›®è§£æ"></a>é¢˜ç›®è§£æ</h3><p>åœ¨è¿™ä¸€æ­¥ä¸­æˆ‘ä»¬è¦å®ç° Storage æ¥å£çš„ä¸€ä¸ªå®ç°ç±» StandAloneStorage, åœ¨ TinyKV ä¸­, Storage æ¥å£æœ‰ä¸‰ä¸ªå®ç°ç±»: MemStorage, RaftStorage å’Œ StandAloneStorage.</p>
<h4 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h4><p>Storage å¯ä»¥ç†è§£ä¸ºå­˜å‚¨å±‚çš„æŠ½è±¡, æä¾› <code>Start()</code>, <code>Stop()</code>, <code>Write()</code>, <code>Reader()</code> å››ç§æ–¹æ³•.</p>
<ul>
<li><code>Start()</code> ä¸ <code>Stop()</code> æ–¹æ³•åªæœ‰ RaftStorage ç±»ä¼šç”¨åˆ°, ç”¨äºå¯åŠ¨/åœæ­¢åº•å±‚ Raft èŠ‚ç‚¹, é¢˜ç›®ä¸­ä¹Ÿæ²¡æœ‰è¦æ±‚æˆ‘ä»¬å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•. ( æ„Ÿè§‰ <code>Start()</code> ä¸ <code>Stop()</code> æ–¹æ³•ä¸­çš„ä¸¤è¡Œ <code>// Your Code Here (1).</code> åº”è¯¥åˆ æ‰ )</li>
<li><code>Write()</code> æ–¹æ³•å‘å­˜å‚¨å±‚ä¸­å†™å…¥å˜æ›´, å˜æ›´çš„ç±»å‹å¯ä»¥æ˜¯ Put æˆ– Delete.</li>
<li><code>Reader()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª StorageReader ç±», æä¾› <code>GetCF()</code>, <code>IterCF()</code>, <code>Close()</code> ä¸‰ç§æ–¹æ³•.<br>æ€»çš„æ¥è¯´, Storage æä¾› <code>Write()</code>, <code>GetCF()</code> å’Œ <code>IterCF()</code> ä¸‰ç§æ“ä½œæ•°æ®çš„æ–¹æ³•.</li>
</ul>
<h5 id="MemStorage"><a href="#MemStorage" class="headerlink" title="MemStorage"></a>MemStorage</h5><p>MemStorage æ˜¯ Storage çš„çº¯å†…å­˜å®ç°, ç¡¬ç¼–ç äº†ä¸‰ä¸ªåˆ—æ—: CfDefault, CfLock å’Œ CfWrite. æ¯ä¸ªåˆ—æ—æ˜¯ä¸€é¢—çº¢é»‘æ ‘,<br><code>Write()</code>, <code>GetCF()</code>, <code>IterCF()</code> ç›´æ¥è°ƒç”¨äº†çº¢é»‘æ ‘çš„ <code>ReplaceOrInsert(item)</code>ã€<code>Delete(item)</code>ã€<code>Get(item)</code> æ–¹æ³•.</p>
<p>Project 4 æµ‹è¯•æ—¶ä½¿ç”¨çš„ Storage ä¾¿æ˜¯ MemStorage.</p>
<h5 id="RaftStorage"><a href="#RaftStorage" class="headerlink" title="RaftStorage"></a>RaftStorage</h5><p>RaftStorage æ˜¯ Storage çš„åˆ†å¸ƒå¼å®ç°. å½“æˆ‘ä»¬ Run TinyKV with TinySQL æ—¶, é»˜è®¤ä¼šä½¿ç”¨è¿™ä¸ª Storage.</p>
<h5 id="StandAloneStorage"><a href="#StandAloneStorage" class="headerlink" title="StandAloneStorage"></a>StandAloneStorage</h5><p>StandAloneStorage æ˜¯ Storage çš„å•æœºå®ç°, æˆ‘ä»¬è¦å®ç°çš„ä¾¿æ˜¯å®ƒ.</p>
<h3 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h3><p>çœ‹äº†é¢˜ç›®ä¹‹åä¸€è„¸æ‡µé€¼, è¿˜å¥½ Storage æ¥å£è¿˜æœ‰å…¶ä»–ä¸¤ä¸ªå®ç°ç±» MemStorage ä¸ RaftStorage.</p>
<p>è¯»äº†è¯»å®ƒä»¬çš„ä»£ç , é¢˜ç›®ä¸­è¦æ±‚åŸºäº badger key/value API, è€Œ MemStorage ä½¿ç”¨çš„æ˜¯çº¢é»‘æ ‘, åªèƒ½å‚è€ƒä¸€ä¸‹ <code>Write()</code> æ—¶å¤„ç† <code>Modify</code> çš„æ–¹æ³•, å…¶ä»–éƒ¨åˆ†æ²¡æœ‰å‚è€ƒä»·å€¼.<br>è¿˜å‰©ä¸‹ RaftStorage , RaftStorage <code>Start()</code> æ—¶æ ¹æ® config æ–°å»ºäº†ä¸€äº› client å’Œ worker å¹¶å¯åŠ¨, <code>Stop()</code> æ—¶å°†å®ƒä»¬åœæ­¢.<br><code>Write()</code> æ—¶, RaftStorage å°† <code>Modify</code> è½¬æ¢ä¸º <code>Put</code> æˆ– <code>Delete</code>, ç„¶åå°†å®ƒä»¬æ‰“åŒ…æˆ request å‘é€åˆ° Raft å±‚. è¿™é‡Œå¹¶æ²¡æœ‰å†™å…¥ badger ç›¸å…³çš„ä»£ç .<br><code>GetCF()</code> æ—¶, RaftStorage ç›´æ¥è°ƒç”¨ <code>engine_util</code> ä¸­çš„æ–¹æ³•åœ¨ badger ä¸­è¯»å–, <code>IterCF()</code> ä¹Ÿç±»ä¼¼.<br>çœ‹äº†çœ‹ <code>engine_util</code> ä¸­çš„æ–¹æ³•, åŸæ¥é¢˜ç›®ä¸­æåˆ°çš„ badger çš„æ“ä½œéƒ½åœ¨è¿™, æ¥ä¸‹æ¥æ€ä¹ˆå†™å°±æ¯”è¾ƒæ¸…æ™°äº†.</p>
<p>StandAloneStorage çš„ <code>Write()</code> æ–¹æ³•åªè¦å°† <code>Modify</code> è§£æä¸º <code>Put</code> æˆ– <code>Delete</code>, å†è°ƒç”¨ <code>engine_util</code> ä¸­çš„æ–¹æ³•å†™å…¥æˆ–åˆ é™¤å°±å¯ä»¥äº†.<br><code>Reader()</code> æ–¹æ³•åªè¦æ–°å»ºä¸€ä¸ªäº‹åŠ¡, å†æ–°å»ºä¸€ä¸ªç±»ä¼¼ <code>RegionReader</code> çš„ Reader å³å¯.<br>Reader <code>Close()</code> æ—¶è®°å¾—è°ƒç”¨ <code>Discard()</code> æ–¹æ³•ç»“æŸäº‹åŠ¡.</p>
<h2 id="Implement-service-handlers"><a href="#Implement-service-handlers" class="headerlink" title="Implement service handlers"></a>Implement service handlers</h2><h3 id="é¢˜ç›®è§£æ-1"><a href="#é¢˜ç›®è§£æ-1" class="headerlink" title="é¢˜ç›®è§£æ"></a>é¢˜ç›®è§£æ</h3><p>åœ¨ä¸Šä¸€æ­¥æˆ‘ä»¬å®ç°äº† StandAloneStorage, ä½†å®ƒçš„æ¥å£å’Œé¢˜ç›®ä¸­å’±ä»¬çš„æœ€ç»ˆç›®æ ‡ <code>Put</code>/<code>Delete</code>/<code>Get</code>/<code>Scan</code> è¿˜ä¸å¤ªä¸€æ ·,<br>åœ¨è¿™ä¸€æ­¥ä¸­æˆ‘ä»¬è¦åˆ©ç”¨ StandAloneStorage å®ç° <code>RawPut</code>/<code>RawDelete</code>/<code>RawGet</code>/<code>RawScan</code> è¿™å››ä¸ªæ–¹æ³•, å¤„ç† request, è¿”å›å¯¹åº”çš„ response.</p>
<h3 id="å®ç°æ€è·¯-1"><a href="#å®ç°æ€è·¯-1" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h3><p>è¦å®ç°çš„å››ä¸ªæ–¹æ³•å±äº Server è¿™ä¸ªç±», Server ç±»ä¸­æ­£å¥½æœ‰ Storage è¿™ä¸€å±æ€§, è¿™ç®—æ˜¯è¡”æ¥ä¸Šäº†.<br>Region æ˜¯ Multi-Raft ä¸­çš„ä¸€ä¸ªæ¦‚å¿µ, åœ¨è¿™ä¸€æ­¥ä¸­æˆ‘ä»¬è¿˜æ²¡æœ‰æ¶‰åŠåˆ° Raft, ä¸çŸ¥é“ä¸ºä»€ä¹ˆç±»ä¼¼ <code>RawGetResponse</code> è¿™æ ·çš„ç±»ä¸­ä¼šæœ‰ <code>RegionError</code> è¿™æ ·çš„å±æ€§, è¿˜æ˜¯å…ˆå¿½ç•¥å§.</p>
<h4 id="RawGet"><a href="#RawGet" class="headerlink" title="RawGet"></a>RawGet</h4><p>ä» Storage ä¸­è·å– Reader, å†è°ƒç”¨ Reader çš„ <code>GetCF</code> å³å¯. æ³¨æ„å‡ºé”™æ—¶è¦å°†é”™è¯¯ä¿¡æ¯èµ‹å€¼ç»™ <code>response.Error</code>, æ²¡æ‰¾åˆ°ç»“æœæ—¶è¦å°† <code>response.NotFound</code> è®¾ç½®ä¸º True.</p>
<h4 id="RawPut-amp-RawDelete"><a href="#RawPut-amp-RawDelete" class="headerlink" title="RawPut &amp; RawDelete"></a>RawPut &amp; RawDelete</h4><p>å…ˆæ„å»º <code>Modify</code>, å†è°ƒç”¨ Storage çš„ <code>Write</code> æ–¹æ³•å³å¯.</p>
<h4 id="RawScan"><a href="#RawScan" class="headerlink" title="RawScan"></a>RawScan</h4><p>ä» Storage ä¸­è·å– Reader, å†ä» Reader ä¸­è·å– Iter, Seek åˆ°å¯¹åº”çš„ Key è¯»å–æœ€å¤š Limit ä¸ªå€¼å³å¯.</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="åœ¨-macOS-ä¸Šåˆ‡æ¢-go-ç‰ˆæœ¬"><a href="#åœ¨-macOS-ä¸Šåˆ‡æ¢-go-ç‰ˆæœ¬" class="headerlink" title="åœ¨ macOS ä¸Šåˆ‡æ¢ go ç‰ˆæœ¬"></a>åœ¨ macOS ä¸Šåˆ‡æ¢ go ç‰ˆæœ¬</h3><p>ç”¨ 1.17.5 ç‰ˆæœ¬çš„ go è¿è¡Œ project æ—¶ä¼šæœ‰å¥‡æ€ªçš„ error<br><code>fatal error: unexpected signal during runtime execution</code>.<br>çœ‹äº†ä¸€ä¸‹ issues åº”è¯¥æ˜¯ go ç‰ˆæœ¬çš„é”…, é™çº§åˆ° 1.16.x ä¾¿å¯.</p>
<p>åœ¨ macOS ä¸­ä½¿ç”¨ brew å¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†è½¯ä»¶çš„ç‰ˆæœ¬.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£… go</span></span><br><span class="line">brew install go</span><br><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£… go 1.16</span></span><br><span class="line">brew install go@1.16</span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ‡æ¢åˆ° go 1.16</span></span><br><span class="line">brew unlink go</span><br><span class="line">brew link go@1.16</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>database project</category>
      </categories>
      <tags>
        <tag>TinyKV</tag>
      </tags>
  </entry>
  <entry>
    <title>TinyKV Project2 RaftKV PartA</title>
    <url>/2022/01/17/tinykv-project2-RaftKV-PartA/</url>
    <content><![CDATA[<p>TinyKV Project2 Part A, å®ç°åŸºæœ¬çš„ Raft ç®—æ³•.</p>
<span id="more"></span>

<h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><p>å®ç°åŸºæœ¬çš„ Raft ç®—æ³•, åŒ…æ‹¬ Leader election å’Œ Log replication.</p>
<h2 id="2AA-Leader-election"><a href="#2AA-Leader-election" class="headerlink" title="2AA Leader election"></a>2AA Leader election</h2><p>Raft ç®—æ³•ä¸­æœ‰ä¸‰ç§çŠ¶æ€, Leader, Candidate å’Œ Follower. Leader è´Ÿè´£å¤„ç†æ‰€æœ‰çš„ Client è¯·æ±‚, Follower åªè¢«åŠ¨åœ°å“åº” Leader æˆ– Candidate çš„è¯·æ±‚. Candidate è´Ÿè´£å‘èµ·é€‰ä¸¾å¹¶å¤„ç†é€‰ä¸¾ç»“æœ.<br>Raft ç®—æ³•ä¸­çš„çŠ¶æ€åŠçŠ¶æ€é—´çš„è½¬æ¢å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º:<br><img src="https://moonm3n-img.oss-cn-chengdu.aliyuncs.com/img/raft-state-transition.jpg" alt="raft-state-transition"><br>åœ¨è¿™ä¸€æ­¥, æˆ‘ä»¬è¦å®ç° Raft å±‚çš„ Leader election éƒ¨åˆ†.</p>
<h3 id="Leader-election-æµç¨‹"><a href="#Leader-election-æµç¨‹" class="headerlink" title="Leader election æµç¨‹"></a>Leader election æµç¨‹</h3><p>Raft ç®—æ³•ä½¿ç”¨éšæœºè®¡æ—¶å™¨æ¥é€‰ä¸¾ Leader, é›†ç¾¤ä¸­é€šå¸¸åªæœ‰ä¸€ä¸ª Leader, Leader ä¼šå®šæœŸå‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å¹¿æ’­å¿ƒè·³æ¥å½°æ˜¾è‡ªå·±çš„é¢†å¯¼æƒ. èŠ‚ç‚¹çš„çŠ¶æ€å¹¶ä¸ä¼šæŒä¹…åŒ–, æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ä»¥ Follower çŠ¶æ€å¯åŠ¨æˆ–é‡å¯.</p>
<p>Leader election çš„æ•´ä½“æµç¨‹ä¸º:</p>
<ol>
<li>å¼€å§‹é€‰ä¸¾.</li>
<li>æ”¶åˆ°å¤§å¤šæ•°ç¡®è®¤é€‰ç¥¨, æˆä¸º Leader.</li>
<li>æ”¶åˆ°å¤§å¤šæ•°å¦å®šé€‰ç¥¨, æˆä¸º Follower.</li>
<li>æ”¶åˆ° Leader æ¶ˆæ¯, æˆä¸º Follower.</li>
<li>è¶…æ—¶é‡æ–°å¼€å§‹é€‰ä¸¾.</li>
</ol>
<p>æ›´ç»†èŠ‚çš„é—®é¢˜:</p>
<ol>
<li>ä»€ä¹ˆæ—¶å€™å¼€å§‹é€‰ä¸¾?<ul>
<li>æ€»çš„æ¥è¯´, å½“ä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºé›†ç¾¤ä¸­æ²¡æœ‰ Leader æˆ–è€… Leader å·²ç»å®•æœºæ—¶, å®ƒä¼šè½¬å˜ä¸º Candidate å¹¶å‘èµ·é€‰ä¸¾. åªæœ‰ Candidate æ‰èƒ½å‘èµ·é€‰ä¸¾.<ul>
<li>å¯¹ Follower è€Œè¨€, åœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ¥è‡ª Leader çš„å¿ƒè·³, æˆ–è€…æ²¡æœ‰ç»™ Candidate æŠ•ç¥¨æ—¶, å®ƒä¼šè½¬å˜ä¸º Candidate å¹¶å‘èµ·é€‰ä¸¾. æ”¶åˆ°æ¥è‡ª Leader çš„å¿ƒè·³è¯´æ˜é›†ç¾¤ä¸­å­˜åœ¨æ­£åœ¨è¿è¡Œçš„ Leader, æŠ•ç¥¨ç»™ Candidate è¯´æ˜ Follower è®¤å¯è¯¥èŠ‚ç‚¹æˆä¸º Leader.</li>
<li>å¯¹ Candidate è€Œè¨€, åœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°è¶³å¤Ÿçš„ç¡®è®¤é€‰ç¥¨æ—¶, å®ƒä¼šè‡ªå¢ term å†æ¬¡å¼€å§‹é€‰ä¸¾.</li>
<li>å¯¹ Leader è€Œè¨€, é™¤éå‘ç°äº†é›†ç¾¤ä¸­æœ‰ term æ›´é«˜çš„ Leader å­˜åœ¨, å¦åˆ™å®ƒä¸ä¼šæ”¾å¼ƒè‡ªå·±çš„é¢†å¯¼æƒ. Leader ä¸ä¼šè½¬å˜ä¸º Candidate, ä¹Ÿå°±ä¸ä¼šå‘èµ·é€‰ä¸¾.</li>
</ul>
</li>
</ul>
</li>
<li>Candidate æ€æ ·å¼€å§‹é€‰ä¸¾?<ol>
<li>èŠ‚ç‚¹è½¬å˜ä¸º Candidate åé¦–å…ˆè‡ªå¢ term.</li>
<li>ä¸ºè‡ªå·±æŠ•ç¥¨.</li>
<li>é‡åˆ¶é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨.</li>
<li>å‘é€è¯·æ±‚æŠ•ç¥¨çš„ RPC ç»™å…¶ä»–æ‰€æœ‰æœåŠ¡å™¨.</li>
</ol>
</li>
<li>Candidate æ€æ ·ç»“æŸé€‰ä¸¾?<ul>
<li>æ¥æ”¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹çš„ç¡®è®¤é€‰ç¥¨, è½¬å˜ä¸º Leader å¹¶ç«‹å³å‘å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³.</li>
<li>å‘ç°äº†å…¶ä»– Leader, ä¸”è¿™ä¸ª Leader çš„ term <strong>ä¸å°äº</strong> è‡ªå·±çš„ term.</li>
<li>é€‰ä¸¾è¶…æ—¶, Candidate ä¼šå†æ¬¡è‡ªå¢ term, ç„¶åé‡æ–°é€‰ä¸¾.</li>
</ul>
</li>
<li>èŠ‚ç‚¹æ€æ ·æŠ•ç¥¨?<ol>
<li>æ¯ä¸ªèŠ‚ç‚¹æ¯ä¸ª term åªä¼šç»™ä¸€ä¸ªèŠ‚ç‚¹æŠ•ç¥¨, å†æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹çš„ RequestVote æ—¶, ç›´æ¥æ‹’ç».</li>
<li>ç”³è¯·é€‰ç¥¨çš„ Candidate å¿…é¡»æœ‰æ›´é«˜çš„ term, å¦åˆ™æ‹’ç».</li>
<li>ç”³è¯·é€‰ç¥¨çš„ Candidate å¿…é¡»æœ‰æ›´æ–°çš„æ—¥å¿—, å¦åˆ™æ‹’ç».</li>
</ol>
</li>
</ol>
<h3 id="Leader-election-å®ç°"><a href="#Leader-election-å®ç°" class="headerlink" title="Leader election å®ç°"></a>Leader election å®ç°</h3><p>æ ¹æ®æ–‡æ¡£çš„æè¿°, æˆ‘ä»¬é¦–å…ˆä» <code>raft.Raft.tick()</code> å¼€å§‹.</p>
<p><code>raft.Raft.tick()</code> çš„ä½œç”¨æ˜¯é€’å¢é€»è¾‘æ—¶é’Ÿ, ä»è€Œé©±åŠ¨é€‰ä¸¾è¶…æ—¶æˆ–å¿ƒè·³è¶…æ—¶. Raft æ ¹æ® term æ¥åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è¿‡æœŸ, ä¸éœ€è¦æ¯”è¾ƒæ¶ˆæ¯å‘é€æ—¶çš„é€»è¾‘æ—¶é—´, å› æ­¤, ä¸éœ€è¦ä¸€ä¸ªå˜é‡æ¥è®°å½•å®é™…çš„é€»è¾‘æ—¶é—´, åªéœ€è¦ç”¨ä¸¤ä¸ªå˜é‡æ¥å¤„ç†é€‰ä¸¾è¶…æ—¶å’Œå¿ƒè·³è¶…æ—¶å³å¯.<br>è§‚å¯Ÿä¸€ä¸‹ Raft ç»“æ„ä½“çš„æˆå‘˜, åœ¨ TinyKV ä¸­, è¿™ä¸¤ä¸ªå˜é‡æ˜¯ <code>heartbeatElapsed</code> å’Œ <code>electionElapsed</code>.<br><code>heartbeatElapsed</code> å¯¹ Leader è€Œè¨€è®°å½•äº†ä¸Šæ¬¡å¿ƒè·³è¶…æ—¶ä»¥æ¥çš„ tick æ•°, å¯¹å…¶ä»–çŠ¶æ€æ— æ•ˆ.<br><code>electionElapsed</code> å¯¹ Leader å’Œ Candidate è€Œè¨€, è®°å½•äº†ä¸Šæ¬¡é€‰ä¸¾è¶…æ—¶ä»¥æ¥çš„ tick æ•°; å¯¹ Follower è€Œè¨€, è®°å½•äº†ä¸Šæ¬¡æ”¶åˆ° Leader çš„æœ‰æ•ˆæ¶ˆæ¯ä»¥æ¥çš„ tick æ•°.</p>
<p><code>raft.Raft.tick()</code> ä¸­åªéœ€è¦é€’å¢è¿™ä¸¤ä¸ªå€¼, ç„¶åæ ¹æ®èŠ‚ç‚¹çš„çŠ¶æ€å¤„ç†è¶…æ—¶å³å¯. éœ€è¦æ³¨æ„çš„æ˜¯, é€‰ä¸¾è¶…æ—¶çš„æ—¶é—´åº”è¯¥æ˜¯éšæœºçš„.</p>
<ul>
<li>å¦‚æœèŠ‚ç‚¹æ˜¯ Leader å¹¶å‘ç”Ÿäº†å¿ƒè·³è¶…æ—¶ -&gt; å¹¿æ’­å¿ƒè·³.</li>
<li>å¦‚æœèŠ‚ç‚¹æ˜¯ Follower å¹¶å‘ç”Ÿäº†é€‰ä¸¾è¶…æ—¶ -&gt; å‘èµ·é€‰ä¸¾.</li>
<li>å¦‚æœèŠ‚ç‚¹æ˜¯ Candidate å¹¶å‘ç”Ÿäº†é€‰ä¸¾è¶…æ—¶ -&gt; é‡æ–°å‘èµ·é€‰ä¸¾.</li>
</ul>
<p>ç„¶åå®ç°çŠ¶æ€è½¬æ¢çš„å‡ ç§æ–¹æ³•, <code>becomeFollower</code>, <code>becomeCandidate</code> å’Œ <code>becomeLeader</code>.</p>
<p>æ¥ä¸‹æ¥éœ€è¦åœ¨ <code>raft.Raft.Step()</code> ä¸­å¤„ç† <code>MessageType_MsgRequestVote</code>, <code>MessageType_MsgRequestVoteResponse</code>, <code>MessageType_MsgHup</code> å’Œ <code>MessageType_MsgBeat</code> è¿™å››ç§ç±»å‹çš„æ¶ˆæ¯.</p>
<ul>
<li><code>MessageType_MsgRequestVote</code><br> 2AA å¹¶ä¸ä¼šæ¶‰åŠåˆ° Raft çš„æ—¥å¿—, åªè¦æ ¹æ® term å¤§å°ä»¥åŠè‡ªå·±æ˜¯å¦åœ¨è¯¥ä»»æœŸæŠ•ç¥¨, è¿”å›æ‹’ç»æˆ–æ¥å—å³å¯.<br> å½“æ¶ˆæ¯çš„ term æ¯”è‡ªå·±çš„æ›´å¤§æ—¶, éœ€è¦å…ˆè½¬å˜ä¸º Follower, å°†è‡ªå·±çš„ term è®¾ç½®ä¸ºæ¶ˆæ¯çš„ term, Lead å’Œ Vote è®¾ç½®ä¸º None, å†åˆ¤æ–­åº”è¯¥æ‹’ç»è¿˜æ˜¯æ¥å—.</li>
<li><code>MessageType_MsgRequestVoteResponse</code><br> é¦–å…ˆå°†ç»“æœæ·»åŠ åˆ°è®°å½•é€‰ç¥¨çš„ <code>raft.Raft.votes</code> ä¸­, ç„¶åç»Ÿè®¡æ”¶åˆ°çš„é€‰ç¥¨.<br> å¦‚æœæ”¶åˆ°çš„è‚¯å®šç¥¨æ›´å¤š, æˆä¸º Leader; å¦‚æœæ”¶åˆ°çš„å¦å®šç¥¨æ›´å¤š, æˆä¸º Follower; å¦‚æœéƒ½ä¸æ˜¯, ç›´æ¥è¿”å›, ç­‰å¾…å…¶ä»–èŠ‚ç‚¹çš„é€‰ç¥¨.</li>
<li><code>MessageType_MsgHup</code><br> æµ‹è¯•æ—¶å‘ç°çš„æ¶ˆæ¯ç±»å‹, æ”¶åˆ°æ—¶èŠ‚ç‚¹åº”è¯¥å…ˆè½¬å˜ä¸º Candidate, ç„¶åå‘èµ·é€‰ä¸¾.</li>
<li><code>MessageType_MsgBeat</code><br> è¿™ç§æ¶ˆæ¯ä¹Ÿæ˜¯æµ‹è¯•æ—¶å‘ç°çš„, æ”¶åˆ°æ¶ˆæ¯æ—¶ç›´æ¥å¹¿æ’­å¿ƒè·³.</li>
</ul>
<p><code>MessageType_MsgHup</code>, <code>MessageType_MsgBeat</code>, ä»¥åŠ 2AB ä¸­ä¼šé‡åˆ°çš„ <code>MessageType_MsgPropose</code>, 3A ä¸­ä¼šé‡åˆ°çš„ <code>MessageType_MsgTransferLeader</code> å’Œ <code>MessageType_MsgTimeoutNow</code> éƒ½æ˜¯ local message. local message å¯ä»¥ç†è§£ä¸ºè‡ªå·±å‘é€ç»™è‡ªå·±çš„æ¶ˆæ¯. å®ƒä»¬éƒ½æ˜¯ä¸å¸¦ä»»æœŸçš„, å³ term ä¸º 0.</p>
<p>ç„¶åéœ€è¦è€ƒè™‘æ€æ ·å‘é€æ¶ˆæ¯. é€šè¿‡æ–‡æ¡£æˆ‘ä»¬çŸ¥é“, åœ¨ 2A ä¸­æˆ‘ä»¬ä¸éœ€è¦å®é™…åœ°å‘é€æ¶ˆæ¯, åªéœ€è¦å°†å®ƒä»¬æ·»åŠ åˆ° <code>raft.Raft.msgs</code> ä¸­å³å¯. åœ¨ TinyKV ä¸­, Raft å±‚ä¸ä¼šç›´æ¥äº¤äº’, è€Œæ˜¯ç­‰å¾…ä¸Šå±‚æ¥è¯»å–å¹¶å‘é€æ¶ˆæ¯.</p>
<p>æœ€åå®ç° <code>raft.Raft.NewRaft()</code>, è¿™é‡Œæ²¡ä»€ä¹ˆå¥½è¯´çš„. ç»“æ„ä½“ä¸­ä¸è®¤è¯†çš„æˆå‘˜è®¾ç½®æˆé»˜è®¤å€¼, ç„¶åé¢å‘æµ‹è¯•ç¼–ç¨‹.</p>
<h2 id="2AB-Log-replication"><a href="#2AB-Log-replication" class="headerlink" title="2AB Log replication"></a>2AB Log replication</h2><p>Raft çš„æ—¥å¿—æ˜¯ä¸€ä¸ª entry æ•°ç»„. æ¯ä¸ª entry ç”± index å’Œ term å”¯ä¸€æ ‡è¯†.</p>
<p>è®ºæ–‡ä¸­çš„è¿™ä¸¤å¥è¯, æè¿°äº†æ—¥å¿—åŒ¹é…çš„ç‰¹æ€§:</p>
<blockquote>
<ul>
<li>å¦‚æœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æ‹¥æœ‰ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·, é‚£ä¹ˆä»–ä»¬å­˜å‚¨äº†ç›¸åŒçš„æŒ‡ä»¤.</li>
<li>å¦‚æœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æ‹¥æœ‰ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·, é‚£ä¹ˆä»–ä»¬ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿå…¨éƒ¨ç›¸åŒ.</li>
</ul>
</blockquote>
<p>Log replication æ˜¯ Raft è¾¾æˆå…±è¯†çš„å…³é”®. åœ¨è¿™ä¸€æ­¥, æˆ‘ä»¬è¦å®ç° Raft å±‚çš„ Log replication éƒ¨åˆ†.</p>
<h3 id="Log-replication-ç›¸å…³æ¦‚å¿µ"><a href="#Log-replication-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="Log replication ç›¸å…³æ¦‚å¿µ"></a>Log replication ç›¸å…³æ¦‚å¿µ</h3><h4 id="æ—¥å¿—æ¡ç›®çš„çŠ¶æ€æµè½¬"><a href="#æ—¥å¿—æ¡ç›®çš„çŠ¶æ€æµè½¬" class="headerlink" title="æ—¥å¿—æ¡ç›®çš„çŠ¶æ€æµè½¬"></a>æ—¥å¿—æ¡ç›®çš„çŠ¶æ€æµè½¬</h4><p>æ—¥å¿—çš„ç»“æ„ä¸º: snapshot/firstâ€¦..appliedâ€¦.committedâ€¦.stabledâ€¦..last</p>
<ul>
<li>last: æœ€åä¸€ä¸ªæ¡ç›®çš„ index.</li>
<li>stabled: å·²ç»æŒä¹…åŒ–çš„æ¡ç›®çš„æœ€å¤§ index.</li>
<li>committed: å·²ç»æäº¤çš„æ¡ç›®çš„æœ€å¤§ index.</li>
<li>applied: å·²ç»åº”ç”¨çš„æ¡ç›®çš„æœ€å¤§ index.</li>
<li>first: ç¬¬ä¸€ä¸ªæ¡ç›®çš„ index.</li>
</ul>
<p>æ·»åŠ æ—¥å¿—æ—¶, å…ˆå°†æ¡ç›®å­˜æ”¾åœ¨å†…å­˜ä¸­, æ­¤æ—¶æ¡ç›®ä½äº (stable, last] ä¸­,<br>ç„¶åç”± Peer å±‚å°†æ¡ç›®æŒä¹…åŒ–, æ­¤æ—¶æ¡ç›®ä½äº (committed, stabled] ä¸­,<br>å†ç”± Raft å±‚å°†æ¡ç›®æäº¤, è¡¨ç¤ºæ¡ç›®å¯ä»¥è¢«åº”ç”¨, æ­¤æ—¶æ¡ç›®ä½äº (applied, committed] ä¸­,<br>æœ€åç”± Peer å±‚å°†æ¡ç›®åº”ç”¨, æ­¤æ—¶æ¡ç›®ä½äº [first, applied] ä¸­.</p>
<h4 id="Leader-ä¸ºå…¶ä»–èŠ‚ç‚¹ç»´æŠ¤çš„å˜é‡"><a href="#Leader-ä¸ºå…¶ä»–èŠ‚ç‚¹ç»´æŠ¤çš„å˜é‡" class="headerlink" title="Leader ä¸ºå…¶ä»–èŠ‚ç‚¹ç»´æŠ¤çš„å˜é‡"></a>Leader ä¸ºå…¶ä»–èŠ‚ç‚¹ç»´æŠ¤çš„å˜é‡</h4><p>Leader é€šè¿‡ nextIndex å’Œ matchIndex æ¥ä¿å­˜å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€.</p>
<p>matchIndex ä¸ºå·²çŸ¥çš„å·²ç»å¤åˆ¶åˆ°è¯¥æœåŠ¡å™¨çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•.<br>nextIndex å‘é€åˆ°è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•.</p>
<p>æ¯ä¸ªèŠ‚ç‚¹æˆä¸º Leader æ—¶, ä¼šå°†æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„ nextIndex åˆå§‹åŒ–ä¸º Leader çš„ lastIndex + 1, matchIndex åˆå§‹åŒ–ä¸º 0.</p>
<h3 id="Log-replication-æµç¨‹"><a href="#Log-replication-æµç¨‹" class="headerlink" title="Log replication æµç¨‹"></a>Log replication æµç¨‹</h3><ol>
<li>æˆä¸º Leader æ—¶, åˆå§‹åŒ–æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„ nextIndex å’Œ matchIndex.</li>
<li>å‘è‡ªå·±çš„æ—¥å¿—ä¸­æ·»åŠ ä¸€ä¸ªæ–°æ¡ç›®.</li>
<li>å¹¿æ’­æ—¥å¿—.</li>
<li>æ¥æ”¶åˆ° Client è¯·æ±‚æ—¶, å°†è¯·æ±‚ä½œä¸ºæ–°æ¡ç›®æ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­, ç„¶åå¹¿æ’­æ—¥å¿—.</li>
<li>æ”¶åˆ°å¿ƒè·³ response æ—¶, å¦‚æœèŠ‚ç‚¹çš„ matchIndex å°äºè‡ªå·±çš„ lastIndex, å¹¿æ’­æ—¥å¿—.</li>
<li>æ”¶åˆ° Append response æ—¶, å¦‚æœæ·»åŠ å¤±è´¥, ä¿®æ”¹å¯¹åº”èŠ‚ç‚¹çš„ nextIndex å¹¶é‡è¯•; å¦‚æœæ·»åŠ æˆåŠŸ, ä¿®æ”¹å¯¹åº”èŠ‚ç‚¹çš„ matchIndex ä¸ nextIndex, ç„¶åè®¡ç®—å¤§å¤šæ•°èŠ‚ç‚¹çš„ matchIndex, å¦‚æœæ¯” commit æ›´å¤§, æ¨è¿› commit.</li>
<li>èŠ‚ç‚¹æ”¶åˆ° Append æ¶ˆæ¯æ—¶, é€šè¿‡æ£€æŸ¥æ¶ˆæ¯çš„ index ä¸ term æ˜¯å¦ä¸è‡ªå·±çš„åŒ¹é…æ¥å†³å®šæ˜¯å¦æ¥å—è¿™äº›æ¡ç›®.</li>
</ol>
<p>æ›´ç»†èŠ‚çš„é—®é¢˜:</p>
<ol>
<li>èŠ‚ç‚¹å¦‚ä½•æ£€æŸ¥æ¶ˆæ¯çš„ index ä¸ term?<ol>
<li>é¦–å…ˆåˆ¤æ–­æ¶ˆæ¯çš„ index æ˜¯å¦æ¯”è‡ªå·±çš„ lastIndex æ›´å¤§, å¦‚æœæ˜¯, è¯´æ˜è‡ªå·±çš„æ—¥å¿—å¤ªå°‘äº†, æ— æ³• Append è¿™äº›æ¶ˆæ¯, åœ¨ Raft ä¸­, æ—¥å¿—æ¡ç›®çš„æ·»åŠ åº”è¯¥æ˜¯è¿ç»­çš„.</li>
<li>å†åˆ¤æ–­æ¶ˆæ¯çš„ term æ˜¯å¦ä¸è‡ªå·±çš„ç´¢å¼•ä¸º index çš„æ¡ç›®çš„ term ä¸€è‡´, å¦‚æœä¸æ˜¯, è¯´æ˜è‡ªå·±ä¸ Leader çš„æ—¥å¿—åœ¨ [first, index] å­˜åœ¨ä¸ä¸€è‡´. Leader åº”è¯¥å‘é€æ›´æ—©çš„æ—¥å¿—, è®© Follower è¦†ç›–è¿™äº›ä¸ä¸€è‡´.</li>
<li>æœ€åå°†æ¶ˆæ¯ä¸­çš„æ‰€æœ‰æ¡ç›®æ·»åŠ æˆ–è¦†ç›–åˆ°è‡ªå·±çš„ entries ä¸­.</li>
</ol>
</li>
</ol>
<h3 id="Log-replication-å®ç°"><a href="#Log-replication-å®ç°" class="headerlink" title="Log replication å®ç°"></a>Log replication å®ç°</h3><p>é¦–å…ˆè¦ç¡®å®šæ—¥å¿—æ¡ç›®çš„å­˜å‚¨ä½ç½®, <code>Raft</code> ç»“æ„ä½“ä¸­æœ‰ <code>RaftLog</code> è¿™æ ·ä¸€ä¸ªæˆå‘˜å˜é‡, å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç®¡ç† Raft log. <code>RaftLog</code> ä¸­ä¹Ÿæœ‰ä¸€ä¸ª Storage, ä½†è¿™ä¸ª Storage ä¸ Project1 ä¸­çš„ Storage ä¸åŒ, Project1 ä¸­çš„ Storage æ˜¯æ•´ä¸ª TinyKV å­˜å‚¨å±‚çš„æŠ½è±¡, è¿™é‡Œçš„ Storage æ˜¯ Raft æ•°æ®å­˜å‚¨çš„æŠ½è±¡.</p>
<p>åœ¨ Raft è®ºæ–‡ä¸­, æ‰€æœ‰æ—¥å¿—æ¡ç›®éƒ½æ˜¯æŒä¹…åŒ–çš„, åœ¨ TinyKV çš„å®ç°ä¸­, æ¡ç›®å…ˆå­˜æ”¾åœ¨ <code>raft.RaftLog.entries</code> ä¹Ÿå°±æ˜¯å†…å­˜ä¸­, å†ç”±ä¸Šå±‚æŒä¹…åŒ–åˆ° <code>raft.Storage</code> ä¸­, åŒæ—¶å†…å­˜ä¸­å§‹ç»ˆä¿æŒæ¡ç›®çš„å‰¯æœ¬. è¿™æ ·åšåº”è¯¥èƒ½å¤Ÿæé«˜è¯»å†™æ•ˆç‡.</p>
<p>Raft èŠ‚ç‚¹å¯åŠ¨æ—¶ä¼šå°è¯•ä» Storage ä¸­è·å–æ—¥å¿—ä»¥åŠèŠ‚ç‚¹çš„çŠ¶æ€, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ <code>raft.newLog</code> éœ€è¦ä¼ å…¥ä¸€ä¸ª Storage å‚æ•°.</p>
<p>åœ¨ 2AB ä¸­, æˆ‘ä»¬éœ€è¦åœ¨ <code>raft.Raft.Step()</code> ä¸­å¤„ç†ä¸€äº›ä¸æ—¥å¿—ç›¸å…³çš„æ¶ˆæ¯.</p>
<ul>
<li><code>MessageType_MsgPropose</code><br> è¿™ä¹Ÿæ˜¯ä¸€ç§ local message, è¡¨ç¤ºå‘ Leader çš„æ—¥å¿—ä¸­æ·»åŠ æ¡ç›®, åªæœ‰ Leader ä¼šå¤„ç†è¿™ä¸€æ¶ˆæ¯.<br> åœ¨è¿™é‡Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç»™è¿™äº›æ¡ç›®è®¾ç½® index ä»¥åŠ term. index ä» lastIndex é€’å¢å³å¯, term ä¸º Leader çš„ term.<br> æ¥ç€æ›´æ–°å…³äºè‡ªå·±çš„ matchIndex, ç”¨äºæ¨è¿› commit. æœ€åå¹¿æ’­ Append.</li>
<li><code>MessageType_MsgAppend</code><br> åœ¨è¿™é‡ŒæŒ‰ç…§ä¹‹å‰æè¿°çš„æ–¹å¼, æ£€æŸ¥æ¶ˆæ¯çš„ index ä¸ term, ç„¶åæ·»åŠ æˆ–è¦†ç›–å³å¯. å¦‚æœæ¶ˆæ¯æºå¸¦çš„ commit æ¯”è‡ªå·±çš„ commit æ›´å¤§, æ¨è¿› commit.</li>
<li><code>MessageType_MsgAppendResponse</code><br> Append æˆåŠŸæ—¶, å°è¯•æ¨è¿› commit; Append å¤±è´¥æ—¶, é‡æ–°å°è¯•å‘é€æ›´æ—©çš„æ—¥å¿—.</li>
<li><code>MessageType_MsgHeartbeat</code><br> é¦–å…ˆæ ¹æ® term è‡ªå·±æ˜¯å¦éœ€è¦è½¬å˜ä¸º Follower, é‡åˆ¶è‡ªå·±çš„é€‰ä¸¾è¶…æ—¶. å¦‚æœæ¶ˆæ¯æºå¸¦çš„ commit æ¯”è‡ªå·±çš„ commit æ›´å¤§, æ¨è¿› commit. æœ€åè¿”å› response.</li>
<li><code>MessageType_MsgHeartbeatResponse</code><br> æ£€æŸ¥ Follower çš„ matchIndex æ˜¯å¦å°äºè‡ªå·±çš„ lastIndex, å¦‚æœæ˜¯, å‘é€ Append.</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯:</p>
<ol>
<li>å¦‚æœé›†ç¾¤ä¸­åªæœ‰ Leader ä¸€ä¸ªèŠ‚ç‚¹, å½“å®ƒæŠŠæ¡ç›®æ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­æ—¶, è¿™ä¸ªæ¡ç›®å°±åº”è¯¥è¢« commit. Leader ä¸ä¼šå‘è‡ªå·±å‘é€ Append æ¶ˆæ¯, ä¹Ÿå°±ä¸ä¼šæ”¶åˆ°æ¥è‡ªè‡ªå·±çš„ Append response, æ— æ³•åœ¨å¤„ç† response æ—¶æ¨è¿› commit.</li>
<li>TinyKV å°†å¿ƒè·³æ‹†æˆäº† Append ä¸ Heartbeat ä¸¤ç§æ¶ˆæ¯, æ¯ä¸ªæ¶ˆæ¯çš„èŒè´£æ›´åŠ æ¸…æ™°. Append æ¶ˆæ¯ä¸»è¦ç”¨äºåŒæ­¥æ—¥å¿—, Heartbeat æ¶ˆæ¯ä¸»è¦ç”¨äºå½°æ˜¾é¢†å¯¼æƒ. Append æ¶ˆæ¯ä¸ Heartbeat æ¶ˆæ¯ä¸­ commit çš„å–å€¼æ˜¯ä¸åŒçš„.<ul>
<li>Follower æ¥æ”¶ Append æ¶ˆæ¯æ—¶ä¼šæ£€æŸ¥ index ä¸ term, æˆåŠŸ Append æ—¶, èƒ½å¤Ÿä¿è¯è‡ªå·±çš„æ—¥å¿—ä¸ Leader çš„æ—¥å¿—æ²¡æœ‰å†²çª. æ‰€ä»¥ Append æ¶ˆæ¯ç›´æ¥ä½¿ç”¨ Leader çš„ commit å³å¯.</li>
<li>Follower æ¥æ”¶ Heartbeat æ¶ˆæ¯æ—¶, å¹¶ä¸ä¼šè¿›è¡Œä¸Šè¿°æ£€æŸ¥. å¦‚æœ Heartbeat æ¶ˆæ¯ç›´æ¥ä½¿ç”¨ Leader çš„ commit æ¥æ¨è¿›è‡ªå·±çš„ commit, å¯èƒ½ä¼š commit å†²çªçš„æ¡ç›®. æ‰€ä»¥ Heartbeat æ¶ˆæ¯çš„ commit éœ€è¦ä½¿ç”¨ <code>min(r.RaftLog.committed, r.Prs[to].Match)</code></li>
</ul>
</li>
</ol>
<h2 id="2AC-Raw-node-interface"><a href="#2AC-Raw-node-interface" class="headerlink" title="2AC Raw node interface"></a>2AC Raw node interface</h2><p>åœ¨ TinyKV çš„æ¶æ„ä¸­, Raft å±‚å¹¶ä¸è´Ÿè´£æŒä¹…åŒ–çŠ¶æ€, èŠ‚ç‚¹é—´ä¹Ÿä¸ä¼šç›´æ¥äº¤äº’, è€Œæ˜¯ç”±ä¸Šå±‚åº”ç”¨å®šæœŸè·å– Raft å±‚çš„çŠ¶æ€å˜æ›´ä»¥åŠèŠ‚ç‚¹æƒ³è¦å‘é€çš„æ¶ˆæ¯, ç”±ä¸Šå±‚åº”ç”¨æ¥æŒä¹…åŒ–çŠ¶æ€å’Œå‘é€æ¶ˆæ¯. RawNode ä¾¿æ˜¯ Raft å±‚ä¸ä¸Šå±‚åº”ç”¨çš„æ¡¥æ¢.</p>
<p>ä¸Šå±‚åº”ç”¨é€šè¿‡ <code>raft.RawNode.HasReady()</code> æ¥åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´, é€šè¿‡ <code>raft.RawNode.Ready()</code> æ¥è·å– Raft å±‚çš„å˜æ›´, å†é€šè¿‡ <code>raft.RawNode.Advance()</code> å°†ä¸Šå±‚å¯¹ Raft å±‚çš„å˜æ›´åº”ç”¨åˆ° Raft å±‚.</p>
<p>è¿™é‡Œå®ç°çš„å‡ ä¸ªæ–¹æ³•ç›¸å¯¹æ¯”è¾ƒç®€å•.</p>
]]></content>
      <categories>
        <category>database project</category>
      </categories>
      <tags>
        <tag>TinyKV</tag>
      </tags>
  </entry>
  <entry>
    <title>TinyKV Project2 RaftKV PartB</title>
    <url>/2022/02/03/tinykv-project2-RaftKV-PartB/</url>
    <content><![CDATA[<p>TinyKV Project2 Part B, åˆ©ç”¨ Raft æ¨¡å—æ„å»ºå®¹é”™çš„ KV å­˜å‚¨æœåŠ¡.</p>
<span id="more"></span>

<h2 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h2><p>åœ¨ Project2A ä¸­, æˆ‘ä»¬å®ç°äº† Raft ç®—æ³•çš„ä¸¤ä¸ªé‡è¦éƒ¨åˆ†: Leader election å’Œ Log replication. æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å®ç°äº†å‡ ä¸ªå¤„ç† Ready ç›¸å…³çš„å‡½æ•°ï¼Œä»¥æå– Raft å±‚çš„å˜æ›´ä¿¡æ¯. æ€»ä½“æ¥è¯´, 2A çš„ä¸»è¦å·¥ä½œéƒ½æ˜¯åœ¨ Raft å±‚.<br>åœ¨ Project2B ä¸­, æˆ‘ä»¬å°† KV å­˜å‚¨å¼•æ“ä½œä¸º Raft ä¸­çš„çŠ¶æ€æœº, å°† Client çš„è¯·æ±‚ä½œä¸ºæ—¥å¿—, æ‰©å±•å‡ºä¸€ä¸ªåŸºäº Raft çš„å®¹é”™ KV å­˜å‚¨æœåŠ¡.</p>
<h2 id="TinyKV-æ¶æ„"><a href="#TinyKV-æ¶æ„" class="headerlink" title="TinyKV æ¶æ„"></a>TinyKV æ¶æ„</h2><p>åœ¨å¼€å§‹ Project2B ä¹‹å‰, æˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ TinyKV çš„æ¶æ„, ä»¥ä¾¿åç»­æ›´å¥½åœ°è¿›è¡Œä»£ç å®ç°.</p>
<p>é¦–å…ˆéœ€è¦äº†è§£å‡ ä¸ªåŸºæœ¬çš„æ¦‚å¿µ:</p>
<ul>
<li>Store: ä¸€ä¸ª tinykv-server.</li>
<li>Peer: tinykv-server ä¸­è¿è¡Œçš„ä¸€ä¸ª Raft node, ä¸€ä¸ª Store ä¸Šå¯èƒ½è¿è¡Œæœ‰å¤šä¸ª Peer, æ¯ä¸ª Peer æ‰€å±äºä¸åŒçš„ Region, åœ¨ 2B ä¸­, åªä¼šæ¶‰åŠåˆ°ä¸€ä¸ª Region.</li>
<li>Region: ä¸€ä¸ª Raft group.</li>
</ul>
<p><img src="https://moonm3n-img.oss-cn-chengdu.aliyuncs.com/img/Xnip2023-02-05_16-56-22.jpg" alt="TinyKV 2B é›†ç¾¤æ¶æ„"></p>
<p>ç»†åŒ–åˆ°ä»£ç å±‚é¢ Raftstore</p>
<p>raftWorker ä¸æ–­åœ°ä» raftCh ä¸­ poll æ¶ˆæ¯, ä¸‹å‘åˆ° Raft æ¨¡å—, å†ä» raft æ¨¡å—ä¸­ è·å– ready å¹¶è¿›è¡Œæ¶ˆæ¯å‘é€ã€çŠ¶æ€æŒä¹…åŒ–ã€å°†æ—¥å¿—åº”ç”¨åˆ°çŠ¶æ€æœºç­‰. æœ€åè¿”å› response.</p>
<h2 id="Implement-peer-storage"><a href="#Implement-peer-storage" class="headerlink" title="Implement peer storage"></a>Implement peer storage</h2><p>åœ¨è¿™ä¸€æ­¥ä¸­, æˆ‘ä»¬éœ€è¦å°† Raft å±‚çš„çŠ¶æ€æŒä¹…åŒ–.</p>
<p>Raft è®ºæ–‡ä¸­æåˆ°çš„éœ€è¦æŒä¹…åŒ–çš„çŠ¶æ€æœ‰:</p>
<ol>
<li>currentTerm: èŠ‚ç‚¹å½“å‰çš„ä»»æœŸ, æ—¢ HardState ä¸­çš„ Term.</li>
<li>votedFor: èŠ‚ç‚¹ç»™è°æŠ•äº†ç¥¨, æ—¢ HardState ä¸­çš„ Vote. å¦‚æœä¸æŒä¹…åŒ– Vote, èŠ‚ç‚¹æŠ•ç¥¨åé‡å¯ä¼šäº§ç”Ÿä¸€ä¸ªèŠ‚ç‚¹åœ¨ä¸€ä¸ª Term ä¸­æŠ•å‡ºä¸¤å¼ ç¥¨çš„ç°è±¡.</li>
<li>log[]: èŠ‚ç‚¹å½“å‰çš„æ—¥å¿—.</li>
</ol>
<p>ä¸ Raft è®ºæ–‡ä¸åŒ, TinyKV ä¸­è¿˜éœ€è¦å°† Commit å’Œ Region ä¿¡æ¯æŒä¹…åŒ–. TinyKV ä¸­çš„ç»å¤§å¤šæ•° request éƒ½æ˜¯å¹‚ç­‰çš„.</p>
<p>å…·ä½“åˆ°ä»£ç ä¸­, æˆ‘ä»¬éœ€è¦å®ç° SaveReadyState() ä¸ Append() ä¸¤ä¸ªå‡½æ•°, 2B ä¸­å¹¶ä¸æ¶‰åŠå¿«ç…§, ApplySnapshot() å‡½æ•°æš‚æ—¶ä¸éœ€è¦å®ç°.</p>
<h3 id="SaveReadyState"><a href="#SaveReadyState" class="headerlink" title="SaveReadyState()"></a>SaveReadyState()</h3><h2 id="Implement-Raft-ready-process"><a href="#Implement-Raft-ready-process" class="headerlink" title="Implement Raft ready process"></a>Implement Raft ready process</h2><p>4<br>HandleRaftReady</p>
<ol>
<li>get the ready from Raft module.</li>
<li>persisting log entries.</li>
<li>applying committed entries.</li>
<li>sending Raft message to other peers.</li>
</ol>
<h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><h3 id="1-panic-find-no-region-for-30203030303030303030"><a href="#1-panic-find-no-region-for-30203030303030303030" class="headerlink" title="1. panic: find no region for 30203030303030303030"></a>1. panic: find no region for 30203030303030303030</h3><p>raft.go newRaft()<br>ä¼˜å…ˆä½¿ç”¨ storage ä¸­çš„ confState.Nodes çš„å€¼.</p>
<h3 id="2-panic-runtime-error-index-out-of-range-18446744073709551611-with-length-1"><a href="#2-panic-runtime-error-index-out-of-range-18446744073709551611-with-length-1" class="headerlink" title="2. panic: runtime error: index out of range [18446744073709551611] with length 1"></a>2. panic: runtime error: index out of range [18446744073709551611] with length 1</h3><p>raft.go sendAppend()<br>index å¤„ç†æœ‰é—®é¢˜</p>
<h3 id="3-ç©ºæŒ‡é’ˆ"><a href="#3-ç©ºæŒ‡é’ˆ" class="headerlink" title="3. ç©ºæŒ‡é’ˆ"></a>3. ç©ºæŒ‡é’ˆ</h3><p>snap çš„ response éœ€è¦æºå¸¦ Region, cd çš„ Txn éœ€è¦èµ‹å€¼, å¦åˆ™ä¼šå‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸.</p>
<h3 id="4-canâ€™t-call-command-header-on-leader-n"><a href="#4-canâ€™t-call-command-header-on-leader-n" class="headerlink" title="4. canâ€™t call command header on leader n"></a>4. canâ€™t call command header on leader n</h3><p>WaitRespWithTimeout è¶…æ—¶äº†.<br>router.peerSender ç®¡é“æ»¡äº†<br>ä¸åœåœ°å‘ router.peerSender ä¸­å‘é€æ¶ˆæ¯, å¯¼è‡´ç®¡é“å µå¡, å¼•å‘å¡æ­».<br>Ready() å‡½æ•°é‡Œæ²¡æœ‰æ¸…ç©º msg.</p>
<h3 id="5-panic-region-1-2-unexpected-raft-log-index"><a href="#5-panic-region-1-2-unexpected-raft-log-index" class="headerlink" title="5. panic: [region 1] 2 unexpected raft log index"></a>5. panic: [region 1] 2 unexpected raft log index</h3><p>â€” FAIL: TestPersistPartition2B (27.40s)<br>panic: [region 1] 2 unexpected raft log index: lastIndex 33539 &lt; appliedIndex 33810 [recovered]</p>
<p>çœ‹èµ·æ¥åƒæ˜¯ lastIndex æŒä¹…åŒ–çš„é€»è¾‘æœ‰é—®é¢˜, é‡å¯èŠ‚ç‚¹æ—¶ç›‘æµ‹åˆ° lastIndex æ¯” appliedIndex æ›´å°, å¼•å‘ panic.<br>ä¿®æ”¹äº†æŒä¹…åŒ–çš„é€»è¾‘åå˜æˆäº†å¶ç° bug, 1% å‡ ç‡å‡ºç°. ä¿®å¤é—®é¢˜ 6 åæ¶ˆå¤±.</p>
<h3 id="6-panic-runtime-error-index-out-of-range-1091-with-length-1087"><a href="#6-panic-runtime-error-index-out-of-range-1091-with-length-1087" class="headerlink" title="6. panic: runtime error: index out of range [1091] with length 1087"></a>6. panic: runtime error: index out of range [1091] with length 1087</h3><p>å¶ç° bug, 3% å‡ ç‡å‡ºç°.<br>bug å‡ºç°æ—¶, è¿™ä¸¤ä¸ª index çš„å·®å€¼ç»å¤§å¤šæ•°æ—¶å€™ä¸º 5, length ä¸º 1087 æ—¶, æœ€åä¸€ä¸ªå…ƒç´ åº”è¯¥æ˜¯ [1086].<br>çœ‹äº†æ—¥å¿—, åœ¨ partition æƒ…å†µä¸‹æ‰ä¼šå‘ç”Ÿ. leader progress é‡Œå­˜å‚¨çš„ next æ¯”è‡ªèº«çš„ lastIndex å¤§äº†æ›´å¤š.<br>åŠ æ—¥å¿—åå®é”¤, append entries è¿”å›äº†å¤§äº leader.lastIndex çš„ index, leader ç”¨è¿™ä¸ª index æ›´æ–°äº† next,<br>äºæ˜¯å‡ºç°äº†æ•°ç»„è¶Šç•Œ.</p>
<p>é”™è¯¯åŸå› :<br>becomeFollower æ—¶å°† Vote è®¾ç½®ä¸ºäº† None, partition åæœ‰å¯èƒ½é€‰å‡ºä¸¤ä¸ª Leader.</p>
<h3 id="7-panic-len-resp-Responses-1"><a href="#7-panic-len-resp-Responses-1" class="headerlink" title="7. panic: len(resp.Responses) != 1"></a>7. panic: len(resp.Responses) != 1</h3><p>å¶ç° bug, 1% å‡ ç‡å‡ºç°.<br>panic: len(resp.Responses) != 1</p>
<p>goroutine 439 [running]:<br>github.com/pingcap-incubator/tinykv/kv/test_raftstore.(*Cluster).MustPutCF(0xc00011f5c0, 0x47f01a0, 0x7, 0xc22a37f5d0, 0xa, 0x10, 0xc22a37f5e0, 0x9, 0x10)<br>    /Users/moon/GolandProjects/tinykv/kv/test_raftstore/cluster.go:308 +0x24d<br>github.com/pingcap-incubator/tinykv/kv/test_raftstore.(*Cluster).MustPut(â€¦)<br>    /Users/moon/GolandProjects/tinykv/kv/test_raftstore/cluster.go:298<br>github.com/pingcap-incubator/tinykv/kv/test_raftstore.GenericTest.func1(0x1, 0xc000001e00)<br>    /Users/moon/GolandProjects/tinykv/kv/test_raftstore/test_test.go:211 +0x41f<br>github.com/pingcap-incubator/tinykv/kv/test_raftstore.runClient(0xc000001e00, 0x1, 0xc21c12fb60, 0xc21e28acf0)<br>    /Users/moon/GolandProjects/tinykv/kv/test_raftstore/test_test.go:27 +0x7a<br>created by github.com/pingcap-incubator/tinykv/kv/test_raftstore.SpawnClientsAndWait<br>    /Users/moon/GolandProjects/tinykv/kv/test_raftstore/test_test.go:37 +0xb2<br>FAIL    github.com/pingcap-incubator/tinykv/kv/test_raftstore    23.630s<br>FAIL<br>rm -rf /tmp/<em>test-raftstore</em></p>
<p>ä¿®å¤é—®é¢˜ 6 åæ¶ˆå¤±.</p>
]]></content>
      <categories>
        <category>database project</category>
      </categories>
      <tags>
        <tag>TinyKV</tag>
      </tags>
  </entry>
  <entry>
    <title>TinyKV Project2 RaftKV PartC</title>
    <url>/2022/02/24/tinykv-project2-RaftKV-PartC/</url>
    <content><![CDATA[<p>TinyKV Project2 Part C, å®ç°å¿«ç…§æœºåˆ¶, å®šæœŸå¯¹æ—¥å¿—è¿›è¡Œå‹ç¼©.</p>
<span id="more"></span>

<p>snapshot çš„å®ç°åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†.</p>
<ol>
<li>å®ç°æ—¥å¿—çš„å®šæœŸæ¸…ç†.</li>
<li>å®ç° snapshot æ•°æ®çš„å‘é€.</li>
</ol>
<h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><h3 id="1-panic-requested-entry-at-index-is-unavailable"><a href="#1-panic-requested-entry-at-index-is-unavailable" class="headerlink" title="1. panic: requested entry at index is unavailable"></a>1. panic: requested entry at index is unavailable</h3><p>è¿™ä¸ªé”™è¯¯å‘ç”Ÿåœ¨èŠ‚ç‚¹é‡å¯, ä» storage ä¸­æ¢å¤ entries æ—¶.</p>
<p>debug å‘ç° storage ä¸­ä»…å­˜å‚¨äº† lo æ‰€åœ¨çš„é‚£ä¸€ä¸ª entry, æ²¡æœ‰ lo åˆ° hi ä¹‹é—´çš„ entries.<br>å›å½’æµ‹è¯• 2b åå‘ç°ä¹Ÿå‡ºç°äº†è¿™ä¸ªé—®é¢˜, åº”è¯¥æ˜¯å†™ 2c æ—¶å½±å“åˆ°äº†.</p>
<p>ä¿®æ”¹ SaveRaftReady() ä¸­åº”ç”¨ snapshot å’Œ append entries çš„é¡ºåºåä¿®å¤.</p>
<h3 id="2-FAIL-TestSnapshotUnreliableRecoverConcurrentPartition2C"><a href="#2-FAIL-TestSnapshotUnreliableRecoverConcurrentPartition2C" class="headerlink" title="2. FAIL: TestSnapshotUnreliableRecoverConcurrentPartition2C"></a>2. FAIL: TestSnapshotUnreliableRecoverConcurrentPartition2C</h3><p>æ²¡æœ‰ä»»ä½•é”™è¯¯æç¤º.<br>çœ‹æ—¥å¿—å‘ç° leader åœ¨ä¸åœåœ° send append.<br>debug å‘ç° first index å°äº truncated index äº†, æ€€ç–‘ truncated index æˆ–è€… first index çš„æŒä¹…åŒ–æœ‰é—®é¢˜.<br>debug å‘ç° send snapshot çš„é€»è¾‘æœ‰é—®é¢˜, æ— æ³•å‘é€ snapshot.</p>
<h3 id="3-FAIL-panic-runtime-error-slice-bounds-out-of-range-1186-384"><a href="#3-FAIL-panic-runtime-error-slice-bounds-out-of-range-1186-384" class="headerlink" title="3. FAIL: panic: runtime error: slice bounds out of range [1186:384]"></a>3. FAIL: panic: runtime error: slice bounds out of range [1186:384]</h3><p>æ›´æ”¹ raft log çš„ first index æ—¶æ²¡æœ‰ä¿®æ”¹ entries æ•°ç»„, å¯¼è‡´ ä» entries æ•°ç»„ä¸­å– entry çš„é€»è¾‘å‡ºé”™.</p>
<h3 id="4-panic-Key-not-found"><a href="#4-panic-Key-not-found" class="headerlink" title="4. panic: Key not found"></a>4. panic: Key not found</h3><p>leader è¯·æ±‚ç”Ÿæˆ snapshot ååˆ†åŒºæ¢å¤, å‡ºç°äº†æ–° leader, æ–° leader å†æ¬¡è¯·æ±‚ snapshot æ—¶ä¾¿ä¼šè§¦å‘è¿™ä¸ªé—®é¢˜.<br>apply snapshot æ—¶ WriteRegionState åè§£å†³.</p>
<h3 id="5-panic-request-timeout"><a href="#5-panic-request-timeout" class="headerlink" title="5. panic: request timeout"></a>5. panic: request timeout</h3><p>leader ä¸€ç›´åœ¨è¯·æ±‚ snapshot, éšåå°± timeout äº†.<br>apply snapshot æ—¶ WriteRegionState åè§£å†³.</p>
]]></content>
      <categories>
        <category>database project</category>
      </categories>
      <tags>
        <tag>TinyKV</tag>
      </tags>
  </entry>
  <entry>
    <title>TinyKV Project3 MultiRaftKV PartB</title>
    <url>/2022/03/05/tinykv-project3-MultiRaftKV-PartB/</url>
    <content><![CDATA[<p>TinyKV Project3 Part B.</p>
<span id="more"></span>

<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>3B ä¸»è¦æ¶‰åŠåˆ° é¢†å¯¼äººå˜æ›´(transfer leader) èŠ‚ç‚¹å˜æ›´(conf change) ä»¥åŠ region åˆ†è£‚(region split).</p>
<h2 id="transfer-leader"><a href="#transfer-leader" class="headerlink" title="transfer leader"></a>transfer leader</h2><p>transfer leader è¯·æ±‚ä¸éœ€è¦ä½œä¸ºä¸€ä¸ª entry åœ¨ Raft group ä¹‹ä¸­åŒæ­¥,<br>peer åœ¨æ”¶åˆ°è¯¥è¯·æ±‚æ—¶, åªéœ€è¦å‘ä¸‹ä¼ é€’ç»™ Raft å±‚æ‰§è¡Œ, å®Œæˆåè¿”å› response å³å¯.</p>
<h2 id="conf-change"><a href="#conf-change" class="headerlink" title="conf change"></a>conf change</h2><p>conf change è¯·æ±‚çš„ä¸»è¦ä½œç”¨æ˜¯å‘ Raft group ä¸­æ·»åŠ æˆ–åˆ é™¤ peer, åˆ†ä¸º add node å’Œ remove node ä¸¤ç§ç±»å‹.</p>
<p>add node: åœ¨ Raft group ä¸­æ·»åŠ èŠ‚ç‚¹, peer åªéœ€è¦æ›´æ”¹è‡ªå·± peerStore å’Œ ctx.storeMeta ä¸­çš„ region,<br>å‘å…¶ä¸­æ·»åŠ  peer å³å¯. store_worker åœ¨å‘è¯¥ peer å‘é€æ¶ˆæ¯æ—¶æ‰ä¼šæ–°å»º peer.</p>
<p>åæ§½: conf change çš„æ¶ˆæ¯ç±»å‹ä»¥åŠå¤„ç†æ–¹æ³•ä¸ºå•¥è¿™ä¹ˆç‰¹åˆ«è€Œåˆåˆ«æ‰­? æ˜¯æœ‰ä»€ä¹ˆç‰¹æ®Šçš„è€ƒè™‘å—.</p>
<p>remove node: åœ¨ Raft group ä¸­åˆ é™¤èŠ‚ç‚¹, å¦‚æœè¢«åˆ é™¤çš„ä¸æ˜¯è‡ªå·±, peer çš„è¡Œä¸ºä¸ add node æ—¶ç±»ä¼¼,<br>å¦‚æœåˆ é™¤çš„æ˜¯è‡ªå·±, ç›´æ¥è°ƒç”¨ destroyPeer() å‡½æ•°å³å¯.</p>
<h2 id="region-split"><a href="#region-split" class="headerlink" title="region split"></a>region split</h2><p>åœ¨æ•°æ®å†™å…¥å, split checker ä¼šå®šæœŸæ£€æµ‹ region çš„å¤§å°, ç¬¦åˆæ¡ä»¶æ—¶, ç”Ÿäº§ region split çš„ key.</p>
<h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><h3 id="1-handle-raft-message-failed-storeID-2-region-1-not-exists-but-not-tombstone"><a href="#1-handle-raft-message-failed-storeID-2-region-1-not-exists-but-not-tombstone" class="headerlink" title="1. handle raft message failed storeID 2, region 1 not exists but not tombstone"></a>1. handle raft message failed storeID 2, region 1 not exists but not tombstone</h3><p>process remove node åˆ é™¤è‡ªå·±æ—¶, é¦–å…ˆè°ƒç”¨äº† destroyPeer() ä¿®æ”¹ RaftLocalState tombstone,<br>åç»­æ²¡æœ‰åˆ¤æ–­è¿™ä¸€æƒ…å†µ, WriteRegionState æ—¶åˆå°† RaftLocalState æ”¹ä¸ºäº† normal.</p>
<h3 id="2-panic-region-1-6-unexpected-raft-log-index-lastIndex-0-lt-appliedIndex-5164"><a href="#2-panic-region-1-6-unexpected-raft-log-index-lastIndex-0-lt-appliedIndex-5164" class="headerlink" title="2. panic: [region 1] 6 unexpected raft log index: lastIndex 0 &lt; appliedIndex 5164"></a>2. panic: [region 1] 6 unexpected raft log index: lastIndex 0 &lt; appliedIndex 5164</h3><p>add node åœ¨ store_worker å®é™…åˆ›å»º peer æ—¶æŠ¥é”™.<br>raftState å’Œ applyState åˆ†åˆ«ä» kv engine å’Œ raft engine ä¸­æ ¹æ® region id è¯»å–å‡º,<br>applyState æ˜¯æ­£å¸¸çš„, raftState å´æ˜¯ç©ºçš„.</p>
<p>åŸå› : process å¤šä¸ª entry æ—¶, conf change è°ƒç”¨ destroyPeer æ¸…ç©ºäº† store,<br>ä¸‹ä¸€æ¡ entry æ‰§è¡Œæ—¶åˆä¼šæ›´æ–° apply index, é‡æ–°å†™å…¥äº† applyState.</p>
<p>process entry æ—¶åº”è¯¥åˆ¤æ–­ d.stopped, å¦‚æœå·²ç»åœæ­¢, ç›´æ¥ return.</p>
<h3 id="3-panic-request-timeout"><a href="#3-panic-request-timeout" class="headerlink" title="3. panic: request timeout"></a>3. panic: request timeout</h3><p>Raft group ä¸­åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹æ—¶, å†åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹, å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ­£å¥½æ˜¯ leader,<br>å¯èƒ½åœ¨ commit æ¶ˆæ¯å‘é€å‰ä¾¿æŠŠè‡ªå·± destroy äº†, å¦ä¸€ä¸ªèŠ‚ç‚¹ä¾¿æ— æ³•å¾—çŸ¥è¿™ä¸€æƒ…å†µçš„å‘ç”Ÿ, æ°¸è¿œæ— æ³•é€‰ä¸¾æˆåŠŸ.</p>
<p>åº”è¯¥å…ˆ transfer leader ç»™å‰©ä¸‹çš„èŠ‚ç‚¹, ç›´æ¥è¿”å›é”™è¯¯, client ä¼šè¿›è¡Œé‡è¯•, å†ç”±å‰©ä¸‹çš„èŠ‚ç‚¹æ¥å¤„ç† remove node.</p>
<h3 id="4-panic-resp-Responses-0-CmdType-raft-cmdpb-CmdType-Put"><a href="#4-panic-resp-Responses-0-CmdType-raft-cmdpb-CmdType-Put" class="headerlink" title="4. panic: resp.Responses[0].CmdType != raft_cmdpb.CmdType_Put"></a>4. panic: resp.Responses[0].CmdType != raft_cmdpb.CmdType_Put</h3><p>åœ¨ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸­åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹åä¼šå‘ç”Ÿè¿™ä¸ªé—®é¢˜. åœ¨ append proposal å¤„æ‰“æ—¥å¿—åå‘ç°,<br>åŒä¸€ä¸ª index çš„ proposal append äº†å¤šæ¬¡.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2022/03/17 15:32:08.334664 peer_msg_handler.go:598: [0;37m[info] [region 1] 3 append proposal type Snap, index 16681[0m</span><br><span class="line">2022/03/17 15:32:08.334670 peer_msg_handler.go:598: [0;37m[info] [region 1] 3 append proposal type Snap, index 16681[0m</span><br><span class="line">2022/03/17 15:32:08.334682 peer_msg_handler.go:598: [0;37m[info] [region 1] 3 append proposal type Put, index 16681[0m</span><br><span class="line">2022/03/17 15:32:08.334686 peer_msg_handler.go:598: [0;37m[info] [region 1] 3 append proposal type Put, index 16681[0m</span><br></pre></td></tr></table></figure>

<p>propose entry å, Raft çš„ last index æ²¡æœ‰å‘ç”Ÿå˜åŒ–. transferLeader äº§ç”Ÿçš„é”™è¯¯æ²¡æœ‰æ­£ç¡®è¿”å›.</p>
<h3 id="5-test-test-go-221-0-31m-fatal-get-wrong-value-client-17"><a href="#5-test-test-go-221-0-31m-fatal-get-wrong-value-client-17" class="headerlink" title="5. test_test.go:221: [0;31m[fatal] get wrong value, client 17"></a>5. test_test.go:221: [0;31m[fatal] get wrong value, client 17</h3><p>ä¸é—®é¢˜ 4 ç›¸åŒ.</p>
<h3 id="6-panic-region-1-4-meta-corruption-detected"><a href="#6-panic-region-1-4-meta-corruption-detected" class="headerlink" title="6. panic: [region 1] 4 meta corruption detected"></a>6. panic: [region 1] 4 meta corruption detected</h3><p>æµ‹è¯•ç”¨ä¾‹: TestSplitConfChangeSnapshotUnreliableRecoverConcurrentPartition3B</p>
<p>å‡ºé”™ä»£ç è¡Œ: /root/tinykv/kv/raftstore/peer_msg_handler.go:867 +0x417</p>
<p>destroyPeer() ä¸­åˆ é™¤ storeMeta regionRanges ä¸­çš„ regionItem æ—¶,<br>å‘ç°å¹¶æ²¡æœ‰å¯¹åº”çš„ regionItem.</p>
<p>applySnapshot() åä¸åº”è¯¥åœ¨ storeMeta ä¸­åˆ é™¤ prevRegion çš„ regionRanges,<br>åœ¨åˆ†åŒºçš„æƒ…å†µä¸‹, ä¸€ä¸ªèŠ‚ç‚¹å¹¶æ²¡æœ‰æ”¶åˆ° split message,<br>åˆ†åŒºæ¢å¤å, æ–°åˆ†è£‚çš„ region çš„ peer å…ˆè¢«åˆ›å»ºå¹¶æ”¶åˆ° snapshot, å‘ storeMeta ä¸­å†™å…¥,<br>å¦ä¸€ä¸ª peer æ”¶åˆ° snapshot æ—¶å¦‚æœåˆ é™¤ prevRegion, å°±ä¼šå¯¼è‡´ panic.<br>prevRegin çš„ endKey æ°å¥½æ˜¯å¦ä¸€ä¸ª peer çš„å·²ç»å†™å…¥çš„ endKey, å› æ­¤ä¸èƒ½åˆ é™¤å®ƒ.</p>
<h3 id="7-panic-split-peer-count-not-equal-to-region-peer-count"><a href="#7-panic-split-peer-count-not-equal-to-region-peer-count" class="headerlink" title="7. panic: split peer count not equal to region peer count"></a>7. panic: split peer count not equal to region peer count</h3><p>è‡ªå®šä¹‰çš„ panic, split request ä¸­çš„ id çš„æ•°ç›®å¯èƒ½ä¸ ç›®å‰é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ•°ä¸ç›¸åŒ, åº”è¯¥æ‹’ç»è¿™ä¸ªè¯·æ±‚.</p>
<h3 id="8-panic-entriesâ€™-high-586-is-out-of-bound-lastIndex-584"><a href="#8-panic-entriesâ€™-high-586-is-out-of-bound-lastIndex-584" class="headerlink" title="8. panic: entriesâ€™ high 586 is out of bound, lastIndex 584"></a>8. panic: entriesâ€™ high 586 is out of bound, lastIndex 584</h3><p>leader å‘ follower è¿ç»­å‘é€ä¸¤æ¬¡å¿«ç…§, follower åº”ç”¨ç¬¬ä¸€ä¸ªå¿«ç…§å¹¶è¿”å› response å,<br>leader ä¼šå‘ follower å‘é€ append entries, æ­¤æ—¶ follower åº”ç”¨äº†ç¬¬äºŒä¸ªå¿«ç…§,<br>follower æ¥å—åˆ° entries åå‘ç°ä»–ä»¬çš„ index æ¯”è‡ªå·±çš„ last index å°, å°è¯•æ›¿æ¢è‡ªå·±çš„æ—¥å¿—,<br>ä½†è‡ªå·±åˆæ²¡æœ‰è¿™äº›æ—¥å¿—, ä¾¿ä¼šå¼•å‘è¿™ä¸ªé”™è¯¯.</p>
<p>è§£å†³æ–¹æ³•: ä¸è°ƒç”¨ panic ç›´æ¥è¿”å›å³å¯.</p>
<h3 id="9-request-timeout"><a href="#9-request-timeout" class="headerlink" title="9. request timeout"></a>9. request timeout</h3><p>3B ä¸­ä¼šé‡åˆ°å„ç§å„æ ·çš„ request timeout.</p>
<h3 id="9-1-send-message-err-message-is-dropped"><a href="#9-1-send-message-err-message-is-dropped" class="headerlink" title="9.1 send message err: message is dropped"></a>9.1 send message err: message is dropped</h3><p>åœ¨æ²¡æœ‰åˆ†åŒºçš„æƒ…å†µä¸‹, leader ä¸€ä¸ªæ—¶é—´æ®µå†…å‘é€çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¸¢å¤±äº†. æ²¡æœ‰æŸ¥æ˜åŸå› , è¿™ä¸ªé—®é¢˜ä¼šå¯¼è‡´ leader å‘é€çš„ snapshot å¾ˆå®¹æ˜“ä¸¢å¤±,<br>åˆå› ä¸ºåœ¨ 2C ä¸­ä¼˜åŒ–äº†å¿«ç…§çš„å‘é€æ¬¡æ•°, å¾ˆå®¹æ˜“å¯¼è‡´è¶…æ—¶.</p>
<h3 id="9-2-tombstone-peer-receives-a-stale-message"><a href="#9-2-tombstone-peer-receives-a-stale-message" class="headerlink" title="9.2. tombstone peer receives a stale message"></a>9.2. tombstone peer receives a stale message</h3><p>è¶…æ—¶å‰å‡ºç°ä¸åœå‡ºç° tombstone peer receives a stale message çš„æ—¥å¿—.</p>
<h3 id="9-3-1-12-14677-is-registered-more-than-1-time"><a href="#9-3-1-12-14677-is-registered-more-than-1-time" class="headerlink" title="9.3 1_12_14677 is registered more than 1 time"></a>9.3 1_12_14677 is registered more than 1 time</h3><p>send snapshot åå‡ºç°è¿™æ¡é”™è¯¯. è¶…æ—¶å‰ä¸åœåœ°å‡ºç°è¿™æ¡é”™è¯¯.<br>å½“é›†ç¾¤ä¸­åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ 1, 2 æ—¶, 1 å‘ 2 å‘é€å¿«ç…§, 2 handel åå‘é€çš„ response ä¸¢å¤±äº†,<br>è¿™æ—¶ 1 æ— æ³• commit æ–°çš„ entry, ä¹Ÿæ— æ³•å‘é€åŒæ ·çš„å¿«ç…§ç»™2, é›†ç¾¤å°±è¿™æ ·æ°¸è¿œä¸å¯ç”¨äº†.</p>
<p>l.Index2Position(i) &lt; len(l.entries)</p>
]]></content>
      <categories>
        <category>database project</category>
      </categories>
      <tags>
        <tag>TinyKV</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰€æœ‰åˆ†ç±»</title>
    <url>/categories/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>æ‰€æœ‰æ ‡ç­¾</title>
    <url>/tags/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
</search>
